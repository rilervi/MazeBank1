<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Maze Bank ‚Äî –ö—Ä–µ–¥–∏—Ç–∏</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="/assets/styles/styles.css">
  <script src="/assets/js/scripthd.js"></script>
</head>
<body>
  <div id="widget"></div>

  <header></header>

  <main class="fade-in">
    <h2>–ú–æ—ó –∫—Ä–µ–¥–∏—Ç–∏</h2>
    <div id="creditList"></div>

    <h3>‚ûï –û—Ñ–æ—Ä–º–∏—Ç–∏ –Ω–æ–≤–∏–π –∫—Ä–µ–¥–∏—Ç</h3>
    <form id="loanForm">
      <label>–°—É–º–∞:
        <input type="number" id="loanAmount" required min="1000">
      </label>
      <label>–¢–µ—Ä–º—ñ–Ω (–º—ñ—Å—è—Ü—ñ–≤):
        <input type="number" id="loanTerm" required min="1">
      </label>
      <label>–ú–µ—Ç–∞:
        <input type="text" id="loanPurpose" required>
      </label>
      <button type="submit">–ü–æ–¥–∞—Ç–∏ –∑–∞—è–≤–∫—É</button>
    </form>

    <h3>üìú –Ü—Å—Ç–æ—Ä—ñ—è –ø–ª–∞—Ç–µ–∂—ñ–≤</h3>
    <ul id="repaymentHistory"></ul>
  </main>

  <script>
    function getCurrentUser() {
      return localStorage.getItem("currentUser");
    }

    function getLoans() {
      const user = getCurrentUser();
      return JSON.parse(localStorage.getItem(`loans_${user}`) || "[]");
    }

    function saveLoans(loans) {
      const user = getCurrentUser();
      localStorage.setItem(`loans_${user}`, JSON.stringify(loans));
    }

    function renderLoans() {
      const list = document.getElementById("creditList");
      const loans = getLoans();
      list.innerHTML = "";

      if (loans.length === 0) {
        list.innerHTML = "<p>–ö—Ä–µ–¥–∏—Ç—ñ–≤ —â–µ –Ω–µ–º–∞—î</p>";
        return;
      }

      loans.forEach((loan, index) => {
        const div = document.createElement("div");
        div.className = "loan-card";
        div.innerHTML = `
          <h4>–ö—Ä–µ–¥–∏—Ç ‚Ññ${index + 1}</h4>
          <p>–°—É–º–∞: ${loan.amount} –≥—Ä–Ω</p>
          <p>–¢–µ—Ä–º—ñ–Ω: ${loan.term} –º—ñ—Å.</p>
          <p>–ú–µ—Ç–∞: ${loan.purpose}</p>
          <p>–°—Ç–∞–Ω: ${loan.paid ? "–ü–æ–≥–∞—à–µ–Ω–æ" : "–ê–∫—Ç–∏–≤–Ω–∏–π"}</p>
          <button onclick="repayLoan(${index})" ${loan.paid ? "disabled" : ""}>üí∏ –ü–æ–≥–∞—Å–∏—Ç–∏</button>
        `;
        list.appendChild(div);
      });
    }

    function renderHistory() {
      const user = getCurrentUser();
      const history = JSON.parse(localStorage.getItem(`loanHistory_${user}`) || "[]");
      const ul = document.getElementById("repaymentHistory");
      ul.innerHTML = "";

      if (history.length === 0) {
        ul.innerHTML = "<li>–ü–ª–∞—Ç–µ–∂—ñ–≤ —â–µ –Ω–µ –±—É–ª–æ</li>";
        return;
      }

      history.forEach(h => {
        const li = document.createElement("li");
        li.textContent = `${h.date} ‚Äî –ü–æ–≥–∞—à–µ–Ω–æ ${h.amount} –≥—Ä–Ω (–ö—Ä–µ–¥–∏—Ç ‚Ññ${h.loanIndex + 1})`;
        ul.appendChild(li);
      });
    }

    function repayLoan(index) {
      const user = getCurrentUser();
      const loans = getLoans();
      if (!loans[index] || loans[index].paid) return;

      loans[index].paid = true;
      saveLoans(loans);

      const history = JSON.parse(localStorage.getItem(`loanHistory_${user}`) || "[]");
      history.push({
        loanIndex: index,
        amount: loans[index].amount,
        date: new Date().toLocaleDateString("uk-UA")
      });
      localStorage.setItem(`loanHistory_${user}`, JSON.stringify(history));

      renderLoans();
      renderHistory();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const user = getCurrentUser();
      if (!user) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å");
        location.href = "index.html";
        return;
      }

      renderLoans();
      renderHistory();

      document.getElementById("loanForm").addEventListener("submit", e => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById("loanAmount").value);
        const term = parseInt(document.getElementById("loanTerm").value);
        const purpose = document.getElementById("loanPurpose").value;

        const newLoan = { amount, term, purpose, paid: false };
        const loans = getLoans();
        loans.push(newLoan);
        saveLoans(loans);

        e.target.reset();
        renderLoans();
      });
    });
  </script>
</body>
</html>
