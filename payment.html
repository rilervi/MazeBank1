<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Maze Bank ‚Äî –ü–ª–∞—Ç–µ–∂—ñ</title>
  <link rel="stylesheet" href="style.css" />
      <link rel="stylesheet" href="/assets/styles//styles.css" />
    <script src="/assets/js/scripthd.js"></script>      
</head>
<body>
  <div id="widget"></div>

  <header></header>

  <main>
    <form id="paymentForm">
      <label>–ö–∞—Ä—Ç–∫–∞ –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è:
        <select id="fromCard" required></select>
      </label>

      <label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ –æ–¥–µ—Ä–∂—É–≤–∞—á–∞:
        <input type="text" id="receiver" maxlength="19" oninput="formatCardNumber(this)" placeholder="0000 0000 0000 0000" required />
      </label>

      <label>–°—É–º–∞:
        <input type="number" id="amount" min="1" step="0.01" required />
      </label>

      <label>–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:
        <input type="text" id="purpose" />
      </label>

      <button type="submit">üí∏ –í–∏–∫–æ–Ω–∞—Ç–∏ –ø–ª–∞—Ç—ñ–∂</button>
    </form>

    <section>
      <h3>üßæ –û—Å—Ç–∞–Ω–Ω—ñ –ø–ª–∞—Ç–µ–∂—ñ</h3>
      <ul id="paymentHistory"></ul>
    </section>
  </main>

  <script>
    function getCurrentUser() {
      return localStorage.getItem('currentUser');
    }

    function showWidget() {
      const email = getCurrentUser();
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.email === email);
      const widget = document.getElementById('widget');
      if (widget && user) {
        widget.textContent = `üë§ ${user.name}`;
      }
    }

    function formatCardNumber(input) {
      let val = input.value.replace(/\D/g, "").substring(0, 16);
      input.value = val.match(/.{1,4}/g)?.join(" ") || "";
    }

    function loadUserCards() {
      const currentUser = getCurrentUser();
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      return cards.filter(c => c.owner === currentUser);
    }

    function loadPayments() {
      const currentUser = getCurrentUser();
      return JSON.parse(localStorage.getItem(`payments_${currentUser}`) || '[]');
    }

    function savePayments(payments) {
      const currentUser = getCurrentUser();
      localStorage.setItem(`payments_${currentUser}`, JSON.stringify(payments));
    }

    function renderCardOptions() {
      const cards = loadUserCards();
      const select = document.getElementById('fromCard');
      select.innerHTML = '';
      cards.forEach(card => {
        const option = document.createElement('option');
        option.value = card.number;
        option.textContent = `${card.type} - ${card.number}`;
        select.appendChild(option);
      });
    }

    function renderPaymentHistory() {
      const payments = loadPayments();
      const list = document.getElementById('paymentHistory');
      list.innerHTML = '';
      if (payments.length === 0) {
        list.innerHTML = '<li>–ù–µ–º–∞—î –ø–ª–∞—Ç–µ–∂—ñ–≤</li>';
        return;
      }
      payments.slice().reverse().forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.date} ‚Äî ${p.from} ‚Üí ${p.to}: ${p.amount.toFixed(2)} –≥—Ä–Ω (${p.purpose})`;
        list.appendChild(li);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const user = getCurrentUser();
      if (!user) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å!');
        location.href = 'index.html';
        return;
      }

      showWidget();
      renderCardOptions();
      renderPaymentHistory();

      const logoutBtn = document.getElementById('logoutLink');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          localStorage.removeItem('currentUser');
          location.href = 'index.html';
        });
      }

      document.getElementById('paymentForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const fromCardNumber = document.getElementById('fromCard').value;
        const receiver = document.getElementById('receiver').value.trim();
        const amount = parseFloat(document.getElementById('amount').value);
        const purpose = document.getElementById('purpose').value || '–ë–µ–∑ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è';

        const cards = JSON.parse(localStorage.getItem('cards') || '[]');
        const cardIndex = cards.findIndex(c => c.number === fromCardNumber && c.owner === user);
        if (cardIndex === -1) {
          alert('–ö–∞—Ä—Ç–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
          return;
        }

        if (cards[cardIndex].balance < amount) {
          alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤!');
          return;
        }

        cards[cardIndex].balance -= amount;
        localStorage.setItem('cards', JSON.stringify(cards));

        const payments = loadPayments();
        payments.push({
          from: fromCardNumber,
          to: receiver,
          amount: amount,
          purpose: purpose,
          date: new Date().toLocaleString()
        });
        savePayments(payments);

        document.getElementById('paymentForm').reset();
        renderPaymentHistory();
        alert('–ü–ª–∞—Ç—ñ–∂ —É—Å–ø—ñ—à–Ω–æ –≤–∏–∫–æ–Ω–∞–Ω–æ!');
      });
    });
  </script>
</body>
</html>
